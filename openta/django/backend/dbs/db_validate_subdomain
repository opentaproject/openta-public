import glob
from exercises.questiontypes.basic import BasicQuestionOps 
from exercises.questiontypes.matrix import MatrixQuestionOps 
from exercises.questiontypes.basic.basic  import IS_CORRECT
from sympy import Matrix
from exercises.parsing import exercise_xml_to_json 
from lxml import etree
from exercises.applymacros import apply_macros_to_node
import os
from exercises.views.api import validate_exercise_xml


def validate_exercises( path ):
    for root, dirname , files in os.walk(path,followlinks=True):
        for file in files :
            if file.split('.')[-1] == 'xml'  and not 'history' in root :
                print(f" DO  root={root} FILENAME = {file}")
                fp = open(f'{root}/{file}',"rb")
                xml = fp.read()
                res = vcheck( xml )
                d = root.split('/')[-1]
                print(f"RES {d}/{file}  = {res}")

def vcheck(  xml  ) :
    root = etree.fromstring(xml)
    name = (root.xpath('./exercisename')[0]).text
    print(f"NAME = {name}")

    usermacros = {}
    usermacros['@user'] = '1' 
    usermacros['@exerciseseed'] = '121' 

    root = apply_macros_to_node( root ,usermacros);
    xml_new = etree.tostring( root,encoding='UTF-8' ).decode();
    #print(f"xml_new = {xml_new}")
    question_xpath = f'/exercise/question'
    question_xmltrees = root.xpath(question_xpath)
    global_xpath = f'/exercise/global'
    global_xmltrees = root.xpath(global_xpath)
    global_xml = "";
    for global_xmltree in global_xmltrees:
        global_xml += etree.tostring( global_xmltree,encoding='UTF-8' ).decode();
    #print(f"glbal_xml = {global_xml}")
    #print(f"QUESTION_XMLTREE = {question_xmltrees} {len( question_xmltrees) } ")
    #ss = global_xml.replace('</global>','')
    ss = ''
    for question_xmltree in question_xmltrees :

        question_xmltree.attrib['user'] = '1' 
        question_xmltree.attrib['username'] = 'super'
        question_xmltree.attrib['exerciseassetpath'] = thispath() 
        question_xmltree.attrib['exercise_key'] =  'abcdefg'
        question_xmltree.attrib['subdomain'] =  'openta'


        atts = question_xmltree.attrib
        key = atts['key']
        #print(f"KEY = {key}")
        expression = ( question_xmltree.xpath('./expression')[0] ).text.strip()
        ss += f"answer{key} = {expression};\n"
    #global_xml = ss + "</global>"
    #print(f"SS = {ss}")
    global_xml = global_xml.replace(f"</global>", ';' + ss + "</global>")
    global_xmltree = etree.fromstring( global_xml)
    #print(f"GLOBAL_XML = {global_xml}")
    res = {}
    for question_xmltree in question_xmltrees :
        question_xml = etree.tostring(question_xmltree, encoding='UTF-8' ).decode();
        #print(f"QUESTION_XML = {question_xml}")
        atts = question_xmltree.attrib
        #print(f"ATTS = {atts}")
        question_json = exercise_xml_to_json( question_xml)
        question_json['@attr'] = question_xmltree.attrib
        #question_json['@attr']['key'] = "randomkey1";
        #question_json['@attr']['type'] ="default"
        key = atts['key']
        (success,msg) = validate_question(question_json, question_xmltree, global_xmltree)
        assertTrue(success == 'success')
        res[key] = (success,msg)
    return res
    assertTrue( success == 'success' )
