#!/bin/bash
set -euo pipefail

# Version to mirror from the private full image
export FULL_VERSION=${FULL_VERSION:-multi}

echo "install: FULL_VERSION=${FULL_VERSION}"

# Login if credentials are provided
if [[ -n "${DOCKERHUB_USERNAME:-}" && -n "${DOCKERHUB_TOKEN:-}" ]]; then
  echo "${DOCKERHUB_TOKEN}" | docker login --username "${DOCKERHUB_USERNAME}" --password-stdin
fi

echo "Building opentaproject/openta-public:${FULL_VERSION} from opentaproject/openta-full:${FULL_VERSION} (Git artifacts removed)"
echo "This may take a few minutes..."

docker buildx build \
  --pull \
  --builder cloud-opentaproject-openta \
  --platform linux/amd64,linux/arm64 \
  --build-arg FULL_VERSION=${FULL_VERSION} \
  -t opentaproject/openta-public:${FULL_VERSION} \
  -t opentaproject/openta-public:latest \
  --push \
  .
